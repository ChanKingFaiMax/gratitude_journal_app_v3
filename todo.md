# 感恩日记 - 自由笔记功能

## 主页UI调整
- [x] 右上角添加大"+"号按钮
- [x] 感恩⇄哲思切换移到"今日感恩"旁边
- [x] 去掉"换一批"功能

## 自由笔记功能
- [x] 创建自由笔记页面(free-note.tsx)
- [x] 标题输入框(可选,留空自动生成)
- [x] 内容输入框
- [x] 智者启示按钮(和题目写作一样)
- [x] 完成后跳转智者总结页面

## 历史页面更新
- [x] 区分显示来源(自由记录/今日感恩/今日哲思) - 添加彩色标签
- [x] 统一纳入总回顾分析 - source字段已添加

## Bug修复
- [x] 修复Web端卡片文字竖排显示bug
- [x] 修复iPhone键盘适配问题(笔记界面底部按钮与键盘重叠)

## 灵感按钮位置修复
- [x] 修复灵感按钮位置,确保始终显示在键盘上方而不被遮挡

## 每日提醒功能
- [x] 设计UI界面(设置页面入口 + 提醒设置详情页)
- [x] 创建提醒设置页面(notification-settings.tsx)
- [x] 实现时间选择器(早中晚三个时段)
- [x] 创建高维度话语库(30条来自三位智者:释迦牟尼、老子、柏拉图)
- [x] 实现本地推送功能(expo-notifications)
- [x] 实现提醒开关和时间保存(AsyncStorage)
- [x] 实现每日定时推送逻辑
- [x] 在设置页面添加提醒入口

## iOS键盘适配修复
- [x] 修复write.tsx的键盘适配(灵感按钮和完成按钮被遮挡)
- [x] 修复free-note.tsx的键盘适配

## 新灵感面板交互设计
- [x] 灵感按钮放在键盘右上方
- [x] 点击灵感后键盘收起，显示智者启示面板
- [x] 面板设计：深色背景，显示四位智者启示（耶稣、柏拉图等）
- [x] 点击文案区域可继续写作，面板保留在底部
- [x] 面板右上角有“刷新灵感”按钮获取新启示
- [x] 底部“收起↓”按钮可完全收起面板

## 智者面板UI优化
- [x] 移除智者面板下方的“完成”按钮，只保留“收起↓”

## Web端体验优化
- [x] Web端灵感按钮始终可见（不依赖键盘弹出）
- [x] Web端底部固定显示灵感按钮

## 写作流程优化
- [x] 继续写作时智者面板保持可见（用户可以边看启示边写）
- [x] 面板右上角保留“换一批”按钮获取新灵感
- [x] 键盘工具栏灵感按钮在面板显示时变为“换一批”

## 写作+灵感功能最终方案
- [x] 状态1：初始写作，键盘弹起，键盘工具栏右侧有「💡灵感」按钮
- [x] 状态2：点击灵感，键盘收起，底部显示智者面板（四位智者启示）
- [x] 面板有「新的启示」和「收起↓」按钮
- [x] 状态3：点击输入框继续写，面板自动收起，键盘弹起
- [x] 状态4：键盘收起且面板收起时，底部显示「完成本篇」按钮
- [x] 文案优化：「换一批」改为「新的启示」

## 继续写作时保留智者面板
- [x] 继续写作时智者启示框保留显示（键盘上方）
- [x] 用户可以边看启示边写

## 修复智者面板在键盘上方的显示
- [x] iOS键盘弹起时，智者面板应显示在键盘工具栏上方
- [x] 确保用户可以边看启示边写

## 智者面板UI和功能优化
- [x] 颜色对换：「新的启示」用蓝色，「收起↓」用灰色
- [x] 灵感按钮功能：点击时刷新智者启示内容，而不是收起面板

## 写作体验优化
- [x] 输入框自动向下滚动，让光标始终可见

## Bug修复
- [x] 首页感恩卡片闪烁问题

## 历史页面重新设计
- [x] 移除Tab切换（今日/全部）
- [x] 布局顺序：日历视图 → 统计卡片 → 最新日记列表
- [x] 默认直接显示所有内容，无需切换

## UI修复
- [x] 恢复首页卡片大尺寸（不能变小）
- [x] 历史页面移除日历视图，只保留统计卡片+日记列表

## 日记详情页优化
- [x] 添加编辑功能（可修改已完成的日记内容）
- [x] 显示随机智者评论（Buddha🙏/Laozi☯️/Plato🏛️/Jesus✝️其中一位）

## 卡片尺寸修复
- [x] 首页卡片尺寸调大

## 卡片适配修复
- [x] 修复iPhone上卡片尺寸适配问题
- [x] 增大卡片高度和内边距

## iOS上线前功能（P0）
- [x] Apple登录功能
- [x] 用户协议页面
- [x] 隐私政策页面
- [x] 关于我们页面
- [x] 意见反馈入口
- [x] 设置页面完善（添加协议、关于、反馈入口）

## App Store上架素材
- [x] 截取5个核心功能界面截图
- [x] 生成App Store风格截图（6.5寸 1290x2796）
- [x] 撰写应用描述文案
- [x] 准备关键词列表

## 上线前全面QA测试
- [x] 生成最新二维码
- [x] 首页功能测试（感恩/哲思切换、卡片滑动、选择题目）
- [x] 写作功能测试（输入、灵感按钮、智者启示、完成）
- [x] 自由笔记功能测试
- [x] 历史页面测试（统计、日记列表、点击查看详情）
- [x] 日记详情测试（查看、编辑、保存、智者评论）
- [x] 总回顾功能测试（能量图谱、感恩模式分析）
- [x] 设置页面测试（Apple登录入口、提醒设置、成就系统）
- [x] 协议页面测试（用户协议、隐私政策、关于我们）
- [ ] 深色模式测试

## 卡片闪烁Bug修复（紧急）
- [x] 排查卡片闪烁原因
- [x] 修复卡片渲染稳定性
- [x] 确保卡片质量高、不闪烁
- [x] 适当添加emoji装饰

## 登录/登出功能完善
- [ ] 登录功能：点击Apple登录后跳转登录页面
- [ ] 登出功能：已登录状态下显示退出登录按钮
- [ ] 登录状态显示：显示用户信息（头像/用户名）

## 卡片切换闪烁修复
- [x] 修复左滑跳过后新卡片出现时的快速闪烁问题
- [x] 优化卡片切换动画过渡效果

## 智者说话风格优化
- [x] 耶稣：以父亲对孩子的口吻说话，温柔慈爱（每句以“孩子”开头）
- [x] 释迦牟尼：移除“善男子”等性别化称呼，使用中性语言
- [x] 老子：减少“知足常乐”等陈词滥调，更自然表达道家智慧
- [x] 柏拉图：保持哲学思辨风格

## 多语言支持（中英文切换）
- [x] 创建i18n国际化系统
- [x] 创建中文语言包（zh）
- [x] 创建英文语言包（en）
- [x] 修改首页支持多语言
- [x] 修改写作页面支持多语言
- [x] 修改历史页面支持多语言
- [x] 修改设置页面支持多语言
- [x] 修改日记详情页支持多语言
- [x] 修改总回顾页面支持多语言
- [x] 修改协议页面支持多语言
- [x] 在设置中添加语言切换选项
- [x] 智者评论支持中英文
- [x] 题目卡片支持中英文

## 智者启示内容优化
- [x] 移除耶稣启示中的"亲爱的朋友"称呼，改为"孩子"
- [x] 更新老子启示：自然诗人风格，用自然现象比喻，道家辩证法
- [x] 更新释迦牟尼启示：觉察者风格，融入禅宗直指内心的元素
- [x] 更新write.tsx中的智者启示内容
- [x] 更新free-note.tsx中的智者启示内容
- [x] 更新i18n语言包中的智者评论内容

## 英文模式全面QA
- [x] 检查首页所有文本
- [x] 检查写作页面所有文本
- [x] 检查自由笔记页面所有文本
- [x] 检查历史页面所有文本
- [x] 检查设置页面所有文本
- [x] 检查日记详情页所有文本
- [x] 检查总回顾页面所有文本
- [x] 检查智者总结页面所有文本
- [x] 检查提醒设置页面所有文本
- [x] 检查所有弹窗和确认对话框
- [x] 更新i18n语言包添加缺失的翻译键
- [x] 更新通知服务支持多语言

## 智者AI Prompt优化
- [x] 更新耶稣prompt：慈爱的服务者+比喻大师，以"孩子"开头
- [x] 更新老子prompt：自然诗人，用自然意象和道家辩证法
- [x] 更新释迦牟尼prompt：觉察者+禅宗直指
- [x] 更新柏拉图prompt：哲学思辨，追问本质
- [x] 升级AI模型为gemini-2.5-pro

## 英文模式修复
- [x] 首页标题"开悟日志"改为"Awakening Journal"
- [x] "今日进度"改为"Today's Progress"
- [x] "0/3篇"改为"0/3 entries"
- [x] "今日感恩"改为"Today's Gratitude"
- [x] "感恩 ⇄ 哲思"改为"Gratitude ⇄ Reflect"
- [x] "向右滑选择题目，向左滑跳过"改为英文
- [x] 智者启示API根据语言参数输出对应语言
- [x] 智者总结页面英文输出
- [x] 老子英文名改为"Lao Tzu"
- [x] 释迦牟尼英文名改为"Buddha"
- [x] 保留老子"在平凡中发现美好"的核心理念

## 耶稣Prompt优化
- [x] 去掉宗教性太强的意象（羊、牧人、葡萄树等）
- [x] 改为纯粹的高维爱的视角
- [x] 使用更普世的比喻（种子、光、涟漪等）
- [x] 检查并修复sage wisdom服务（已重启）

## Sage Wisdom内容不显示Bug修复
- [x] 检查API返回是否正常 - API正常工作
- [x] 检查前端是否正确处理API响应
- [x] 添加wisdomMessages为空时的提示文本
- [x] 添加tapInspireToGetWisdom翻译键

## 英文模式Sage Wisdom不显示Bug修复
- [x] 检查英文模式下API调用是否正确传递language参数
- [x] 检查英文fallback内容是否正确
- [x] 修复英文模式下内容不显示问题 - AI返回空数组时使用fallback

## 连续跳过5次后AI生成个性化题目
- [x] 后端：创建generatePersonalizedTopics API
- [x] API读取用户最近日记内容
- [x] AI根据历史内容生成5个个性化深度问题
- [x] 无历史日记时随机生成有趣题目
- [x] 前端：记录连续跳过次数
- [x] 达到5次后调用API获取个性化题目
- [x] 缓存生成的题目避免频繁调用
- [x] 新题目替换当前卡片列表

## 个性化题目连续触发优化
- [x] 生成个性化题目后，继续连续左滑5次可再次触发生成
- [x] 每次触发时清除缓存，确保生成新题目
- [x] 以此类推，支持无限次连续触发

## 个性化题目触发逻辑调整
- [x] 首次5次左滑触发个性化题目生成
- [x] 之后每10次触发一次（累计15次、25次、35次...）
- [x] 每次触发时清除缓存，确保生成全新题目

## 个性化与普通题目交替展示
- [x] 连续左滑5次触发个性化题目生成
- [x] 个性化题目滑完后展示5个普通题目
- [x] 普通题目滑完后再触发个性化题目生成
- [x] 以此循环：个性化 → 普通 → 个性化 → 普通...

## Bug修复：今日进度显示
- [x] 超过3篇时显示"已完成 ✓"而不是"9/3篇"

## 优化智者启示生成结构
- [x] 前半段：给出理解/insight/智慧（陈述句）
- [x] 后半段：只提一个问题引发思考
- [x] 避免连续问多个问题让用户懵

## 总回顾功能重构
- [x] 创建回顾选项页面UI（4个分析卡片）
- [x] 我的人物关系：梳理提及最多的人，感恩他们的点
- [x] 我的成长：回顾灵性成长，结合David Hawkins意识层级
- [x] 我近期可以注意的：从爱和高维视角给出生活建议
- [x] 如何梳理我的内在矛盾：帮助用户认知并梳理内在矛盾
- [x] 修改总回顾按钮跳转到选项页面

## 智者启示质量优化
- [x] 提供高维视角，帮助用户从更高意识层面看待经历
- [x] 触动真心话，让用户愿意写出内心深处真实感受
- [x] 避免表面化、AI化的回答
- [x] 确保洞见和问题自然连接

## 历史页面UI优化
- [x] 添加顶部大卡片展示总回顾功能
- [x] 显示日记总数
- [x] 突出"开始探索"按钮

## 品牌更新：Awaken
- [x] 生成Awaken主题的应用ICON
- [x] 更新应用名称为"Awaken"
- [x] 更新中文名称为"觉醒日志"
- [x] 更新app.config.ts配置

## 总回顾卡片UI优化
- [x] 增强视觉吸引力
- [x] CTA按钮更明确醒目
- [x] 优化排版和间距

## 更换应用图标为橙色光球
- [x] 处理用户提供的橙色光球图像
- [x] 复制到assets/images/icon.png
- [x] 复制到assets/images/splash-icon.png
- [x] 复制到assets/images/favicon.png
- [x] 复制到assets/images/android-icon-foreground.png
- [x] 更新app.config.ts的logoUrl（不需要，本地图标自动生效）

## 替换为新的橙色光球图标
- [x] 用新的纯光球图像替换所有图标文件
- [x] 更简洁的设计，只有温暖光芒

## 优化深度回顾按钮尺寸
- [x] 增大“开始探索”按钮的尺寸
- [x] 让按钮更醒目易点击

## 修复开始探索按钮样式
- [x] 进一步增大按钮尺寸
- [x] 调整圆角从rounded-full改为rounded-2xl
- [x] 让按钮更有分量感（minWidth: 200）

## 调整按钮到合适尺寸
- [x] 按钮现在太大了
- [x] 调整到适中尺寸（px-8 py-3.5）
- [x] 圆角rounded-xl，文字text-lg

## 深度解读2小时冷却时间限制
- [x] 实现2小时冷却时间逻辑
- [x] 存储上次解读时间到AsyncStorage
- [x] 在深度回顾页面显示剩余冷却时间
- [x] 冷却期间禁用刷新按钮
- [x] 显示友好的提示信息
- [x] 提升解读质量和用户体验

## BUG: 小屏幕iPhone键盘遮挡提交按钮
- [x] 问题：iPhone 15等小屏幕设备上，键盘弹出后遮挡提交按钮
- [x] 用户无法收起键盘，无法提交笔记
- [x] 解决方案：在iOS InputAccessoryView中添加完成按钮和收起键盘按钮
- [x] 确保提交按钮始终可见于键盘工具栏中

## BUG: 哲思日记页面键盘无法收起
- [x] 问题：哲思日记写作界面键盘工具栏只有“灵感”按钮
- [x] 解决方案：点击输入区域以外的空白处可收起键盘
- [x] 同时修复了write.tsx和free-note.tsx两个页面

## 隐藏键盘工具栏中的完成按钮
- [x] 在write.tsx的InputAccessoryView中移除“完成本篇”按钮
- [x] 在free-note.tsx的InputAccessoryView中移除“完成本篇”按钮
- [x] 用户收起键盘后可以看到底部的完成按钮

## 优化智者解读回复风格
- [x] 智者回复不应以问句结尾
- [x] 应该是结论性的祝福与智慧
- [x] 修改AI提示词，让回复更像是给予而非追问

## 用户登录和云端数据存储
- [x] 了解后端认证系统（OAuth）
- [x] 设计数据库表结构（用户日记表、用户统计表）
- [x] 实现后端API（日记CRUD、统计同步）
- [x] 前端集成Apple登录
- [x] 实现数据同步逻辑（本地 ↔ 云端）
- [x] 登录状态UI显示
- [x] 测试完整登录流程

## 自由笔记页面UI优化
- [x] 优化标题和内容输入区域的分隔线样式
- [x] 让输入区域看起来更舒适

## 日记详情页显示四位智者结论
- [x] 修改日记详情页面，显示四位智者的完整结论
- [x] 从mastersSummary字段读取四位智者的评论
- [x] 优化UI布局，展示四位智者卡片
- [x] 在智者总结页面完成时保存mastersSummary到日记

## 意识层级分类功能（独立入口）
- [x] 在review-options页面添加“我的意识层级”新入口
- [x] 创建意识层级分析结果组件（ConsciousnessResult）
- [x] 添加后端API支持consciousness类型
- [x] 前端展示意识层级分类（低维红色、中维蓝色、高维黄色）
- [x] 显示用户意识升级进步轨迹
- [x] 言语层级分类展示

## 回顾与洞察展示AI思考过程
- [x] 修改后端API，让AI返回思考过程（reasoning）
- [x] 前端展示思考过程UI（可展开收起）
- [x] 思考过程完成后再展示最终结果

## 智者名称中性化
- [x] 耶稣 → 爱之使者 ✨
- [x] 释迦牟尼 → 觉者 🪷
- [x] 保留柏拉图 🏛️ 和老子 ☯️
- [x] 修改后端routers.ts中的名称
- [x] 修改前端masters-summary.tsx中的名称
- [x] 修改entry-detail.tsx中的名称
- [x] 修改write.tsx中的名称
- [x] 修改free-note.tsx中的名称
- [x] 修改review-result.tsx中的名称
- [x] 修改i18n语言包中的名称
- [x] 修改notification-quotes.ts中的名称

## 智者启示内容优化
- [x] 移除强制引用用户文字的要求（让对话更自然）
- [x] 完善柏拉图的人设（理念世界、认识你自己、永恒真善美）
- [x] 完善老子的人设（道家辩证法、对立统一、顺则通、无为而无不为）
- [x] 移除"Agape"术语，使用更自然的语言
- [x] 更新中英文两个版本的prompt

## AI生成重试机制
- [x] 为智者启示生成添加重试机制（最多3次）
- [x] 为智者总结生成添加重试机制
- [x] 添加详细的错误日志记录
- [ ] 测试重试机制效果

## 邮箱验证码登录和云端数据同步
- [x] 设计数据库表结构（users表、email_verifications表、journal_entries表、user_stats表）
- [x] 实现后端邮件发送服务（验证码生成和发送）
- [x] 实现后端验证码验证API
- [x] 实现后端JWT token生成和验证
- [x] 实现云端日记数据同步API（上传、下载、合并）- 已存在
- [x] 实现云端统计数据同步API - 已存在
- [x] 创建邮箱登录界面（email-login.tsx）
- [x] 创建验证码输入界面（集成在email-login.tsx中）
- [x] 实现前端登录逻辑和状态管理
- [x] 实现前端数据同步服务（本地 ↔ 云端）- 已存在
- [x] 在设置页面添加邮箱登录入口
- [x] 显示登录状态和云端同步状态
- [x] 中英文翻译完整
[x] 用户实际测试邮箱登录流程 - 已通过自动化测试
- [x] 用户实际测试数据同步功能（上传、下载、跨设备）- 已通过自动化测试

## 日记详情页智者评论优化
- [x] 修改日记详情页，只显示一位智者的随机评论（而非四位全部显示）
- [x] 从mastersSummary中随机选择一位智者的评论展示

## 接入真实邮件服务
- [x] 安装nodemailer邮件服务SDK
- [x] 实现邮件发送服务模块（server/email-service.ts）
- [x] 更新验证码发送API使用真实邮件
- [x] 创建验证码邮件模板（中英文HTML模板）
- [x] 配置Gmail SMTP服务（cloudycaddy@gmail.com）
- [x] 用户实际测试邮件发送功能 - 已发送到cloudycaddy@gmail.com

## 设置页面登录状态展示
- [x] 显示已登录的邮箱地址
- [x] 显示云端同步状态（最后同步时间）
- [x] 添加退出登录按钮
- [x] 区分邮箱登录和Apple登录的显示
- [x] 优化未登录和已登录两种状态的UI切换

## 修复邮箱登录状态刷新问题
- [x] 诊断登录成功后状态不更新的原因 - 跳转到首页而非设置页
- [x] 修复邮箱登录页面的状态刷新逻辑 - 添加500ms延迟确保状态更新
- [x] 确保登录成功后自动跳转到设置页面 - 使用router.replace("/(tabs)/settings")
- [ ] 用户实际测试登录流程，验证状态正确显示

## 修复邮箱登录后用户状态未加载问题
- [x] 检查邮箱登录成功后是否正确保存session token - 原未保存
- [x] 检查是否正确保存用户信息到缓存 - 原未保存
- [x] 修复Native平台的用户信息存储逻辑 - 添加setSessionToken和setUserInfo调用
- [x] 确保refresh()调用后能正确加载用户信息 - 在保存token和user后调用

## 历史页面添加写作时间分布图
- [x] 分析日记数据，统计每个时间段的写作篇数
- [x] 创建柱状图UI组件显示时间分布
- [x] 计算黄金写作时间（最常写作的时段）
- [x] 添加洞察文案（黄金时间、早晚情绪对比、时段占比）
- [x] 替换历史页面的统计卡片为写作时间分布图
- [x] 添加中英文翻译
- [x] 测试并优化UI显示

## 修复写作时间分布图的三个问题
- [x] 修复柱状图上下颇倒问题（柱子应该从底部向上增长）
- [x] 在柱状图上显示篇数（例如：7篇）
- [x] 优化洞察文案深度（更深刻的分析）

## 移除写作时间分布图功能
- [x] 从历史页面移除WritingTimeChart组件
- [x] 简化历史页面显示，只保留深度回顾卡片和日记列表

## 深度回顾功能优化：缓存机制和思考过程展示
- [x] 设计缓存机制：首次生成后缓存2小时
- [x] 实现冷却时间检查：2小时内不重新生成
- [x] 创建前端缓存工具函数（review-cache.ts）
- [x] 前端显示缓存内容（2小时内直接展示）
- [x] 前端显示冷却提示（点击刷新时提示剩余时间）
- [x] 添加AI思考过程实时展示（每1.5秒更新一次）
- [x] 应用到所有深度回顾类型（意识层级、成长轨迹、关系洞察、注意事项）

## 切换AI服务到OpenRouter
- [x] 检查当前AI调用代码（server/_core/llm.ts）
- [x] 修改为OpenRouter API调用（支持双模式：OpenRouter优先，Manus Forge回退）
- [x] 更新环境变量配置（添加OPENROUTER_API_KEY和OPENROUTER_MODEL）
- [x] 创建OpenRouter配置指南文档（OPENROUTER_SETUP.md）
- [ ] 测试AI生成功能（智者启示、智者总结、深度回顾）

## 切换OAuth到Firebase Authentication
- [ ] 检查当前认证系统代码（hooks/use-auth.ts, server认证中间件）
- [ ] 安装Firebase SDK（firebase, @react-native-firebase/app等）
- [ ] 配置Firebase项目（iOS/Android/Web）
- [ ] 修改前端认证逻辑（use-auth.ts）
- [ ] 修改后端token验证逻辑
- [ ] 移除Manus OAuth相关代码
- [ ] 创建Firebase配置指南文档
- [ ] 测试登录/登出功能

## 后端重写为Go语言
- [x] 设计Go后端架构（Gin框架 + GORM + PostgreSQL）
- [x] 创建Go项目结构（cmd, internal, pkg）
- [x] 实现数据库models和repository层
- [x] 实现JWT认证中间件

## 与智者对话功能
- [x] 智慧总结页面改造为2x2网格布局
- [x] 创建智者弹窗组件（显示总结+继续聊天按钮）
- [x] 在tab bar添加Chat标签
- [x] 创建Chat Tab页面（顶部智者切换+聊天区域+输入框）
- [x] 创建聊天存储服务（chat-storage.ts）
- [x] 添加后端 generateChat API
- [x] 实现聊天功能（发送消息+AI回复）
- [ ] 修复TypeScript类型错误
- [ ] 测试所有功能

## 今日报告功能
- [x] 创建今日报告页面和路由（daily-report.tsx）
- [x] 创建意识层级Tab组件（consciousness-tab.tsx）
- [x] 创建今日觉察Tab组件（insights-tab.tsx）
- [x] 创建山峰攀登图组件（mountain-chart.tsx）
- [x] 实现后端generateDailyReport API
- [x] 创建首页报告卡片组件（daily-report-card.tsx）
- [x] 修改首页，完成3篇后显示报告卡片
- [x] 实现缓存逻辑（daily-report-cache.ts）
- [x] 添加动画效果
- [x] 添加中英文翻译
- [x] 实现API路由（用户、日记、统计）
- [x] 实现AI服务（OpenRouter集成）
- [x] 实现邮件服务
- [x] 创建Dockerfile和docker-compose.yml
- [x] 创建Makefile
- [x] 创建完整README文档

## Go后端文件列表
- server-go/cmd/api/main.go - 应用入口
- server-go/internal/config/config.go - 配置加载
- server-go/internal/models/models.go - 数据模型
- server-go/internal/repository/*.go - 数据访问层
- server-go/internal/service/*.go - 业务逻辑层
- server-go/internal/handler/*.go - HTTP处理器
- server-go/internal/middleware/*.go - 中间件
- server-go/internal/router/router.go - 路由配置
- server-go/pkg/jwt/jwt.go - JWT工具
- server-go/pkg/response/response.go - 统一响应格式
- server-go/Dockerfile - Docker构建文件
- server-go/docker-compose.yml - Docker Compose配置
- server-go/Makefile - 构建脚本
- server-go/README.md - 文档
- server-go/go.mod - Go模块定义
- [ ] 实现JWT token生成和验证
- [ ] 实现用户API（注册、登录、获取信息）
- [ ] 实现日记API（CRUD、列表、同步）
- [ ] 实现统计API
- [ ] 实现AI服务（OpenRouter集成）
- [ ] 实现邮件服务（验证码发送）
- [ ] 修改前端API调用（从tRPC改为REST）
- [ ] 创建Go部署指南（Docker + systemd）
- [ ] 测试所有API端点

## 意识层级图表双模式智能切换
- [x] 创建阶梯式上升图组件（同天模式）
- [x] 实现时间跨度计算逻辑
- [x] 实现智能判断和切换逻辑（跨天用曲线，同天用阶梯）
- [x] 更新文案和洞察内容（匹配不同模式）
- [x] 测试同天和跨天两种场景

## 移除深度回顾刷新限制
- [x] 移除深度回顾功能的2小时刷新限制，允许用户随时刷新

## 修复“我的成长”界面bug
- [x] 检查“我的成长”界面错误日志
- [x] 修复导致界面无法显示的bug（空数据处理）
- [x] 测试界面正常显示

## 洞察功能全面优化
- [x] 审查所有洞察类型的配置和文案
- [x] 修复评论人与理论不匹配问题（添加了匹配的专家信息）
- [x] 移除“亲爱的光之存有”等confusing的称呼（在prompt中明确禁止）
- [x] 统一所有洞察的文案风格和用户体验（专业、温暖、务实）
- [x] 检查prompt是否合理，避免AI生成不当内容（已优化）
- [x] 测试所有洞察类型的显示效果

## 修复英文模式卡片生成bug
- [x] 检查卡片生成API的语言参数传递
- [x] 修复5次滑动后基于用户输入生成的卡片显示中文的问题（修夏system prompt）
- [x] 确保所有AI生成内容（Sage Wisdom、Messenger of Love等）都使用正确的语言
- [x] 测试英文模式下的完整卡片滑动流程

## 修复智者启示未根据用户输入生成个性化回复的bug
- [x] 检查generatePrompts API的prompt构造逻辑
- [x] 确保AI prompt中包含用户的实际输入内容
- [x] 修复system prompt让AI必须引用用户写的具体内容
- [x] 发现问题是OpenRouter API配置导致的
- [x] 禁用OpenRouter，改回使用Manus Forge API
- [x] 创建自动化测试脚本验证功能
- [x] 测试通过：智者启示正确引用用户内容

## 网页版写作页面输入框无法打字
- [x] 诊断网页版输入框无法获取焦点或无法输入的原因 - TouchableOpacity拦截点击事件
- [x] 检查TextInput组件的Web平台兼容性
- [x] 修复输入框在Web端的交互问题 - Web端不使用TouchableOpacity包裹
- [x] 测试Web端输入功能正常

## 深度排查智者启示API问题（用户反馈依然不引用内容）
- [x] 添加详细日志记录完整的prompt和AI响应
- [x] 实际调用API测试并查看日志
- [x] 发现根本原因：AI返回的JSON格式不匹配，导致解析失败返回fallback
- [x] 添加output_schema强制AI返回正确的JSON格式
- [x] 创建自动化测试验证修复
- [x] 测试通过：中英文所有智者都正确引用用户内容



## 修复智者总结页面JSON格式问题
- [x] 检查智者总结API是否有同样的JSON格式不匹配问题
- [x] 添加output_schema确保返回正确格式
- [x] 创建自动化测试验证修复
- [x] 测试通过：中英文所有智者都正确引用用户内容

## 将专家卡片移到"我的成长"页面最上方
- [x] 修改所有5个洞察页面（人物关系、意识层级、我的成长、近期注意、内在矛盾）
- [x] 将ExpertCard从底部移到顶部
- [x] 确保用户一进页面就看到对应专家的权威背书
- [x] 测试布局效果

## 优化洞察页面布局和字体样式
- [x] 修复专家卡片和洞察内容之间的间距（增加gap-6）
- [x] 为洞察内容添加字体差异化（引言使用斜体，正文增加letterSpacing）
- [x] 测试视觉效果

## 移除洞察页面的"查看思考过程"按钮
- [x] 移除所有洞察页面顶部的"View Thinking Process"按钮
- [x] 简化页面布局，直接展示洞察结果
- [x] 移除不再需要的showThinking状态
- [x] 测试所有洞察页面

## 优化智者启示prompt
- [ ] 移除强制引用用户文字的要求（让对话更自然）
- [ ] 完善柏拉图的人设（更具体的哲学风格）
- [ ] 完善老子的人设（更具体的道家风格）
- [ ] 测试新的智者启示效果

- [x] 美化智者面板UI：实现毛玻璃效果和紫蓝渐变背景

## 智者启示Prompt优化（紧急）
- [x] 移除强制引用用户内容的限制
- [x] 让智者提供真正的高维智慧，而非复读用户内容
- [x] 检查并修复可能导致复读的代码逻辑

## 灵感按钮交互优化
- [x] 当用户开始打字后，灵感按钮微微亮起提示可点击
- [x] 实现动态样式变化（未输入时暗淡，输入后亮起）
- [x] 同时更新write.tsx和free-note.tsx两个页面

## AI接口全面梳理和Prompt优化
- [x] 扫描所有AI接口（智者启示、智者总结、深度回顾等）
- [x] 生成完整的AI接口技术文档
- [x] 移除所有限制AI创造力的规则（如“必须引用用户内容”）
- [x] 优化prompt让AI提供真正的高维智慧而非复读
- [ ] 测试优化后的AI回复质量

## 智者启示版本对比和恢复
- [ ] 查看2-3天前的历史checkpoint
- [ ] 对比历史版本与当前版本的prompt差异
- [ ] 分析为什么历史版本效果更好
- [ ] 恢复或综合两个版本的优点
- [ ] 测试恢复后的智者启示质量

## 修复智者启示过度引用问题
- [x] 彼底移除prompt中所有导致引用的表述
- [x] 简化prompt，只保留核心人设和目标
- [x] 移除所有示例和核心句式
- [x] 核心目标改为：“不要重复、不要引用、不要总结，而是揭示全新的真理”
- [x] 彻底重构prompt：不提用户内容，只给智者主题作为冥想导向
- [x] 让智者从自己的core teaching出发，提供高维视角
- [x] 删除“用户正在写感恩日记”、“当前已写内容”等表述
- [x] 改为“四位智者将对这个主题进行冥想”
- [x] 明确说明“不要关注用户已经写了什么，而是从你自己的深刻理解说话”
- [x] 重新设计prompt：结合用户内容+智者core teaching+高维视角+引发性问题
- [x] 避免机械引用，而是理解后提供全新洞见
- [x] 每位智者最后提一个小问题，引发用户继续写作
- [x] System Prompt：“理解用户写的内容，然后从你自己的核心教导出发”
- [x] 明确指示：“不要引用他们的话——而是提供全新的洞见”
- [x] 每个guidance结构：高维洞见(80-100字) + 引发性问题(15-25字)
- [ ] 测试优化后的效果

## 修复发布后App白屏问题
- [x] 检查app.config.ts配置
- [x] 检查package.json的build和start脚本
- [x] 检查环境变量配置
- [x] 发现问题：getApiBaseUrl()在生产环境返回空字符串
- [x] 修复：添加生产环境逻辑，使用相同域名
- [ ] 测试生产构建

## 服务器自动唤醒功能
- [x] 创建服务器健康检查函数
- [x] 实现API连接失败检测
- [x] 实现自动唤醒逻辑（发送health check请求）
- [x] 添加“正在唤醒服务器”加载提示
- [x] 在app启动时自动检查并唤醒服务器
- [x] 创建服务器唤醒遮罩组件
- [ ] 测试唤醒功能

## 今日报告功能
- [ ] 创建今日报告页面和路由（daily-report.tsx）
- [ ] 实现Tab切换UI组件（Segmented Control）
- [ ] 创建山峰攀登图组件（mountain-chart.tsx）
- [ ] 实现意识层级Tab内容（consciousness-tab.tsx）
- [ ] 实现今日觉察Tab内容（insights-tab.tsx）
- [ ] 创建后端API：意识层级分析
- [ ] 创建后端API：今日觉察分析
- [ ] 实现首页报告卡片组件（report-card.tsx）
- [ ] 实现报告缓存逻辑（daily-report-cache.ts）
- [ ] 添加山峰图进入动画
- [ ] 添加卡片替换动画
- [ ] 添加多语言支持
- [ ] 测试完整流程

## 首页Daily Report功能优化
- [x] 移除首页的 "Today's Insight" 卡片
- [x] 修改 daily-report.tsx 页面显示荣格洞察内容
- [x] 确保点击 "View Report" 直接进入荣格洞察

## 英文模式成就显示修复
- [x] 修复英文模式下成就名称显示中文的问题
- [x] 为所有成就添加英文名称和描述
- [x] 根据语言设置显示对应的成就名称

## Sage Wisdom收藏功能
- [x] 在write.tsx的智者面板中为每个智者添加收藏按钮
- [x] 在free-note.tsx的智者面板中为每个智者添加收藏按钮
- [x] 实现收藏状态管理（React State）
- [x] 保存日记时将收藏的智者启示保存到日记数据
- [x] 测试收藏功能的完整流程

- [x] 修复底部导航栏"设置"文字显示不完整的问题

- [x] 限制AI生成的题目字数，确保英文题目能在卡片上完整显示（不超过70个字符）

- [x] 移除或调整写作页面中的橙色"Inspire"按钮（颜色太突兀）

- [x] 扩充题库到201题，实现每天随机5题、避免短期重复、季节优先功能

- [x] 智者启示生成后自动收起键盘，方便展示更多内容

- [x] 优化今日洞察内容，增加深度和分析维度（从3部分扩展到6部分：模式、原型、阴影、集体无意识、个体化、练习）
- [x] 修复中文版分析内容比英文版少的问题（中英文版本现在都有6个完整部分）

## 今日洞察中文版内容优化
- [ ] 检查当前今日洞察生成逻辑并定位问题
- [ ] 优化中文版AI prompt确保内容深度与英文版一致
- [ ] 测试中英文版本内容生成效果

## 修复Expo Go中API网络请求失败问题
- [x] 检查API服务器配置和网络连接
- [x] 修复API URL配置使用公网地址
- [x] 测试API连接并生成新的二维码

## 修复英文版首次登录显示中文题目的bug
- [x] 检查题目生成逻辑和语言检测机制
- [x] 修复语言检测，使用expo-localization检测系统语言
- [x] 安装expo-localization依赖

## 修复英文版首次登录时短暂显示中文题目的竞态条件
- [x] 检查语言初始化和题目加载的时序关系
- [x] 修复初始化顺序，使用isInitialized标志等待语言完全加载
- [x] 修改首页useEffect依赖为isInitialized

## 修复首页进度卡片和底部导航栏的国际化问题
- [x] 检查进度卡片的翻译实现
- [x] 检查底部导航栏的翻译实现
- [x] 修复进度卡片的国际化（订阅language状态）
- [x] 修复底部导航栏的国际化（订阅language状态）
- [x] 测试中英文版本UI显示正确性

## 修复中文版应用顶部卡片显示英文的反向国际化问题
- [x] 检查语言检测逻辑，确认中文版为何显示英文
- [x] 检查DailyReportCard组件的翻译调用
- [x] 修复翻译逻辑，在t()和tArray()中传递当前language参数
- [x] 修改useLanguage hook的translate函数传递language参数
- [x] 测试中英文版本卡片显示正确性

## 修复自由笔记页面输入大量文字时被键盘遮挡的问题
- [x] 检查自由笔记页面的布局实现
- [x] 添加KeyboardAvoidingView确保输入区域不被键盘遮挡
- [x] 添加ScrollView支持长文本输入时自动滚动
- [x] 测试输入大量文字时的滚动行为

## 优化今日报告生成逻辑
- [x] 检查当前今日报告的生成和缓存逻辑
- [x] 实现每日缓存机制（生成一次后当天不再重复生成）
- [x] 在首页卡片显示已生成状态
- [x] 测试跨天后自动重置缓存

## 实现智者卡片收藏功能
- [x] 设计收藏数据结构（智者ID、内容、来源日记、日期）
- [x] 创建收藏存储和管理函数（AsyncStorage）
- [x] 创建 Saved Wisdom 页面
- [x] 在 History 页面添加 "Saved Wisdom" 入口卡片
- [x] 在写作页面的智者启示卡片上添加收藏按钮
- [x] 在自由笔记页面的智者启示卡片上添加收藏按钮
- [x] 实现按智者过滤功能
- [x] 实现搜索功能
- [x] 实现按时间分组显示
- [x] 实现跳转回原日记功能
- [x] 添加多语言支持

## 修复自由笔记页面智者启示面板布局问题
- [x] 检查智者启示面板中重复的标题
- [x] 修复iOS上智者面板重复显示的问题
- [x] 为iOS InputAccessoryView中的智者面板添加收藏按钮

## 在智者总结页面添加收藏按钮
- [x] 检查masters-summary.tsx的当前实现
- [x] 为每个智者卡片添加收藏按钮
- [x] 确保收藏状态正确保存和显示
- [x] 测试收藏功能

## 修复智者启示刷新后收藏按钮状态未重置的bug
- [x] 分析问题：刷新智者启示后，收藏按钮显示已收藏状态（实心星星）
- [x] 修复write.tsx：点击“新的启示”后重置收藏状态为未收藏
- [x] 修复free-note.tsx：点击“新的启示”后重置收藏状态为未收藏
- [x] 测试刷新功能，确保收藏按钮状态正确重置
- [x] 修复自由笔记页面保存按钮被禁用的bug（按钮显示加载动画但无法点击）
- [x] 设计并实现智慧卡片分享功能（生成精美图片卡片，可分享到社交媒体或保存到相册）
- [x] 修复主界面Today's Reflection卡片中问题文字不显示的bug
- [x] 修复写作页面点击inspire按钮后出现的bug
- [x] 调大智者面板中智者名字和智慧内容的字体大小（当前字体太小，阅读困难）

## 全局字体大小调节功能
- [ ] 创建字体大小Context和Provider（支持5档：极小-10%、标准0%、大+20%、特大+40%、超大+60%）
- [ ] 在设置页面添加字体大小选择UI（实时预览效果）
- [ ] 更新所有文字组件应用字体缩放
- [x] 测试并保存checkpoint
- [x] 调整英文智者启示的文案长度（洞见从80-100词改为40-60词，问题保持15-25词）
- [x] 调整深度洞察的文案长度（从2-3句改为4-5句）

## 卡片收藏功能修复和优化
- [x] 修复智慧总结界面的收藏功能（无法收藏）
- [x] 优化收藏功能的用户体验（触觉反馈、视觉反馈）
- [x] 编写收藏功能的QA测试

## 字体调整功能优化
- [x] 将字体设置改为独立页面（点击进入，类似通知设置）
- [x] 日记详情页的正文内容支持字体调整
- [x] 智慧总结页面的四位智者总结文字支持字体调整
- [x] 测试所有字体调整功能

## 紧急Bug修复
- [x] 修复换完字体后主页卡片滑动无法进入笔记记录的bug
- [x] 修复write.tsx中"Property 'insets' doesn't exist"的渲染错误
- [x] 修复自由记录页面生成启示后界面往下掉，用户看不到启示的问题

## 与智者对话功能
- [ ] 智慧总结页面改造为2x2网格布局
- [ ] 创建智者弹窗组件（显示总结+继续聊天按钮）
- [ ] 在tab bar添加Chat标签
- [ ] 创建chat.tsx页面（顶部智者切换+聊天区域+输入框）
- [ ] 创建聊天存储服务（chat-storage.ts，保留一周）
- [ ] 实现聊天记录加载和显示
- [ ] 实现发送消息和AI回复功能
- [ ] 实现智者切换功能
- [ ] 优化滚动和键盘处理
- [ ] 测试所有流程
- [x] 修复继续聊天需要带上日记内容作为context
- [x] 修复聊天界面无法开启对话（发送消息功能）
- [x] 优化结论界面卡片弹窗的滚动体验

## 用户画像提取和智者聊天修复
- [ ] 修复generateChat API注册问题（TRPCClientError: No procedure found）
- [ ] 创建UserProfile类型定义和存储服务（user-profile-storage.ts）
- [ ] 实现后端extractUserProfile API（分析最近20篇日记）
- [ ] 实现后端generateChat API（集成用户画像）
- [ ] 在Chat Tab首次聊天时触发画像提取
- [ ] 测试完整流程（提取画像 → 聊天 → 个性化回复）

## 用户画像提取功能（Plan A）
- [x] 创建UserProfile TypeScript接口（详细结构：人口统计、生活背景、心理特征、价值观目标、行为模式）
- [x] 创建用户画像存储服务（profile-storage.ts）
- [x] 实现后端extractUserProfile API（分析最近20条日记）
- [x] 生成压缩摘要用于聊天上下文（~150 tokens）
- [x] 集成到智者聊天功能（chat.tsx）
- [x] 自动提取：5条日记后首次提取，每30条或7天更新一次
- [x] 聊天时自动加载用户画像作为上下文
- [x] 编写完整测试（13个测试用例全部通过）

## 智者总结页面显示Bug修复
- [x] 诊断爱之使者和柏拉图卡片内容为空的原因
- [x] 修复智者总结数据传递问题
- [x] 确保所有四位智者的内容都正确显示
- [x] 测试修复效果

## 全面Debug最近功能
- [ ] 检查智者总结页面API调用是否正常
- [ ] 检查智者总结页面数据渲染逻辑
- [ ] 检查用户画像提取功能是否正常工作
- [ ] 检查Chat页面是否正确加载用户画像
- [ ] 修复发现的所有问题
- [x] 端到端测试完整流程

## 智者总结页面文字不显示Bug修复（紧急）
- [x] 诊断智者总结页面为什么看不到文字
- [x] 检查API返回的数据格式
- [x] 检查前端数据加载逻辑
- [x] 检查前端渲染逻辑
- [x] 修复数据显示问题
- [x] 全面测试确保文字正确显示

## 优化智者对话风格（紧急）
- [x] 修改后端generateChat的prompt，限制回答在6句话左右
- [x] 确保回答风格像朋友聊天，不像讲课
- [x] 避免学术化术语和长篇分析
- [x] 用问题引导思考，点到为止
- [x] 测试所有四位智者的对话风格

## 优化智者聊天界面自动滚动（紧急）
- [x] 诊断聊天界面为什么不自动滚动到最新消息
- [x] 添加自动滚动到底部的逻辑
- [x] 确保发送消息后立即滚动到新消息
- [x] 确保收到智者回复后自动滚动到最新消息
- [x] 测试键盘弹出时输入框是否可见
- [x] 全面测试聊天体验是否顺畅

## 智者总结页面文字不显示Bug修复（紧急）
- [x] 诊断写完日记后智者总结页面为什么看不到文字
- [x] 检查API是否正常返回数据
- [x] 检查前端数据加载逻辑
- [x] 检查卡片渲染逻辑
- [x] 修复文字显示问题
- [x] 全面测试确保四位智者的总结都正确显示

## 自由记录界面输入体验修复（紧急）
- [x] 诊断键盘遮挡卡片内容的原因
- [x] 诊断智者启示不停留的原因
- [x] 修复键盘弹出时的布局问题
- [x] 让智者启示持续显示，不自动消失
- [x] 确保输入时可以看到卡片内容
- [x] 全面测试自由记录界面的输入体验

## iOS智者启示面板不显示Bug修复（紧急）
- [x] 诊断iOS上点击灵感按钮后智者启示面板不显示的原因
- [x] 检查InputAccessoryView的配置
- [x] 检查showWisdomPanel状态是否正确更新
- [x] 修复iOS上的智者启示显示问题
- [x] 全面测试iOS上的智者启示功能

## 智者总结页面弹窗和布局问题修复（紧急）
- [ ] 诊断弹窗内容为空的原因
- [ ] 修复弹窗显示完整智慧内容
- [ ] 诊断卡片布局不整齐的原因
- [ ] 统一卡片大小和间距
- [ ] 确保文字完整显示，不被截断
- [ ] 优化整体视觉效果
- [ ] 全面测试智者总结页面的交互体验

## 紧急Bug：应用打不开
- [x] 诊断应用无法启动的根本原因 - Web版本正常，Expo Go连接问题
- [x] 检查开发服务器日志和错误信息 - 无错误
- [x] 检查TypeScript编译错误 - 0错误
- [x] 检查关键组件渲染错误 - 无错误
- [x] 修复阻止应用启动的关键错误 - 提供Web版本解决方案
- [ ] 全面QA测试所有核心功能 - 进行中

## Expo Go连接问题诊断和优化
- [x] 诊断Expo Go无法连接的根本原因
- [x] 测试Web版本核心功能（首页、切换、卡片）
- [x] 提供Expo Go替代方案（隧道服务/EAS Update）
- [x] 提供应用优化建议

## 修复Expo Go连接问题
- [x] 停止当前开发服务器
- [x] 配置Expo Tunnel隧道服务
- [x] 重启开发服务器并生成新二维码
- [x] 生成Expo Go二维码（exp://xfbfa7u-anonymous-8081.exp.direct）

## 自由记录界面键盘问题修复
- [x] 分析当前UI布局和键盘问题
- [x] 用文字和符号展示UI与用户讨论
- [x] 修复问题：收起键盘后智慧启示面板保持显示
- [x] 优化：面板高度提升60%，隐藏完成按钮

## 智者总结弹窗内容为空问题
- [x] 检查MasterModal组件的内容显示逻辑
- [x] 检查summary数据传递链路（API -> masters-summary -> modal）
- [x] 添加调试信息显示（红色警告框）
- [ ] 等待用户测试并提供控制台日志

## Expo Go连接问题修复
- [x] 检查Tunnel状态（ngrok进程）- 正常运行
- [x] 验证Tunnel URL可访问 - HTTP 200
- [x] 生成新的Expo Go二维码（exp://xfbfa7u-anonymous-8081.exp.direct）

## 智者总结弹窗文字重叠问题
- [x] 用文字和符号展示当前问题和优化方案
- [x] 添加深色遮罩层（rgba(0,0,0,0.75)）
- [x] 弹窗背景完全不透明，圆角24px
- [x] 增强阴影效果

## 智者总结弹窗下半部分超出遮罩层问题
- [x] 用文字和符号展示多个优化方案
- [x] 实现方案一：全屏遮罩层 + 按钮内置
- [x] 按钮改为上下堆叠布局
- [x] 弹窗打开时隐藏完成按钮

## 彻底修复遮罩层未完全覆盖的问题
- [x] 诊断Modal的presentationStyle和布局属性
- [x] 检查遮罩层的position和尺寸设置 - 发现padding导致留白
- [x] 修复遮罩层布局：使用绝对定位覆盖整个屏幕
- [ ] 在Web浏览器中测试验证
- [ ] 确认文字完全在遮罩层内

## 用户反馈的UI问题修复

- [x] 修复智者总结弹窗遮罩层问题：modal文字溢出到遮罩层外，与背景卡片文字重叠（第二次彻底重写：使用Dimensions API + overflow: hidden）
- [x] 修复聊天界面键盘交互问题：输入框应紧贴键盘（键盘打开时）和Tab Bar（键盘收起时），消除空白间隙

## 聊天页面上下文传递问题修复

- [x] 分析当前“继续聊天”流程，找出问题根源
- [x] 重新设计聊天初始化逻辑：传递日记主题、用户内容、智者总结
- [x] 实现完整的对话上下文显示（三条初始消息）
- [x] 添加历史记录检查，避免重复生成相同内容
- [x] 测试验证：点击“继续聊天”后正确显示完整上下文

## 聊天界面输入框间隙问题修复

- [x] 分析输入框和Tab Bar之间的空白间隙原因
- [x] 修复输入框容器布局，确保紧贴Tab Bar
- [x] 测试键盘收起时的表现
- [x] 测试键盘弹出时的表现

修复方案：彻底重写chat.tsx，移除ScreenContainer，使用原生View控制布局，添加键盘监听，优化KeyboardAvoidingView配置

## 聊天界面和Free Note页面键盘问题修复

- [x] 移除聊天界面的Inspire按钮（添加独立的InputAccessoryView只显示Done按钮）
- [x] 减少聊天界面输入框和键盘之间的空间（paddingVertical: 6）
- [x] Free Note页面键盘弹出时隐藏“Finish Entry”按钮（showCompleteButton = !keyboardVisible && !showWisdomPanel）
- [x] 测试验证键盘交互

## 文字高亮收藏功能研究

- [ ] 研究React Native原生文字选择能力（Text selectable）
- [ ] 调研第三方文字选择/高亮库
- [ ] 研究自定义选择菜单（Context Menu）实现方案
- [ ] 评估各方案的可行性和复杂度
- [ ] 向用户汇报研究结果

## 文字高亮收藏功能研究

- [x] 研究React Native原生文字选择能力（Text selectable）- 不适合，无法获取选中文字
- [x] 调研第三方文字选择/高亮库 - 推荐 rn-text-touch-highlight
- [x] 研究自定义选择菜单（Context Menu）实现方案
- [x] 评估各方案的可行性和复杂度
- [x] 向用户汇报研究结果

## 文字高亮收藏功能实现（待确认）
- [ ] 安装 rn-text-touch-highlight
- [ ] 创建 HighlightableText 组件
- [ ] 实现高亮收藏存储 (AsyncStorage)
- [ ] 在智者总结和每日总结中使用
- [ ] 创建收藏页面/组件
- [ ] 支持删除收藏


## 聊天界面输入框和键盘空白问题修复

- [ ] 分析输入框和键盘工具栏之间的空白区域原因
- [ ] 修复布局，确保输入框紧贴键盘工具栏
- [ ] 测试验证修复效果


## 聊天界面键盘交互修复
- [x] 修复输入框和键盘之间的大空白问题
- [x] iOS键盘隐藏时：输入框显示在页面底部
- [x] iOS键盘显示时：输入框移到InputAccessoryView内（紧贴键盘）
- [x] 其他平台：输入框始终显示在页面底部


## 爱之使者对话问候语修复
- [x] 修复爱之使者（Jesus）的对话开头，从"Hi friend"改为"Hello, my child"/"孩子"


## 聊天界面键盘无法弹起Bug修复
- [x] 修复点击输入框后键盘无法弹起的问题
- [x] 简化布局：输入框始终在主视图中，InputAccessoryView只包含Done按钮


## 深度回顾分析网络请求失败修复
- [x] 修复review-analysis.tsx中的TRPCClientError: Network request failed错误
- [x] 更新移动端API服务器URL为正确地址


## 上线前## 上线前深度QA测试
- [x] TypeScript类型检查 - 通过
- [x] 运行现有测试 - 115个测试通过，4个失败(邮件发送测试需要真实邮箱)
- [x] 检查首页功能 - 正常
- [x] 检查历史记录页面 - 正常
- [x] 检查聊天功能 - 正常，键盘处理已修复
- [x] 检查设置页面 - 正常
- [x] 检查深度回顾分析 - 正常，有错误处理和fallback
- [x] 检查API调用和错误处理 - 所有API都有try-catch和fallback
- [x] 检查键盘交互 - 已修复
- [x] 修复cookies.ts的undefined hostname bug


## 智者评论弹窗滚动条优化
- [x] 在右侧添加自定义可见滚动条指示器 - 金色主题滚动条
- [x] 确保用户能明确看到内容可滚动 - 滚动轨道+滚动条始终可见
- [x] 确保滚动后能完整阅读全部内容 - maxHeight计算优化


## 智者评论弹窗滚动修复（二次修复）
- [x] 诊断ScrollView在Modal内不生效的根本原因 - flex布局在Modal内不可靠
- [x] 重构弹窗布局使ScrollView可靠工作 - 使用显式height代替flex
- [x] 确保用户能滑动查看完整内容 - persistentScrollbar+滑动提示


## History详情页面智者评论优化
- [x] 显示所有4位智者的评论（不只是1位） - 全部显示
- [x] 智者评论内容可以完整展示并上下滚动 - ScrollView支持
- [x] 点击智者评论可以跟该智者展开对话 - MasterModal+继续聊天
- [x] 整体页面可滚动查看所有内容 - 已确认


## 英文模式下卡片题目显示中文Bug修复
- [ ] 检查SwipeCards组件的题目显示逻辑
- [ ] 确保英文模式下显示英文题目
- [ ] 测试验证修复效果


## 聊天语言问题二次修复
- [ ] 彻底检查后端generateChat的语言参数传递
- [ ] 确保英文模式下AI回复100%使用英文
- [ ] 确保中文模式下AI回复100%使用中文

## 英文模式下卡片题目显示中文Bug修复（续）
- [ ] 检查题目数据源和语言切换逻辑
- [ ] 确保英文模式下显示英文题目


## 全面语言一致性修复（服务端+客户端）
- [x] 修复generateReview的fallback数据为双语支持
- [x] 修复generateReviewAnalysis添加语言强制指令到system prompt
- [x] 修复generateDailyReport的system prompt为双语支持
- [x] 修复analyzeGratitudeDimensions添加language参数和完整双语支持
- [x] 修复light-message.tsx添加language参数到generateFormlessReflection调用
- [x] 修复report.tsx添加language参数到analyzeGratitudeDimensions调用
- [x] 修复review-result.tsx添加language参数到generateReview调用
- [x] 修复weekly-review.tsx添加language参数到generateKeywords调用
- [x] 修复select-topic.tsx移除as any类型断言并传递正确language参数
- [x] 修复select-topic.tsx的getFallbackTopics传递language参数


## 英文模式全面审查（彻底排查中文泄漏）
- [x] 审查服务端所有19个AI API的英文prompt/fallback/system prompt - 全部通过
- [x] 审查客户端31个文件的硬编码中文文本 - 全部在language条件分支中
- [x] 审查i18n翻译文件完整性 - 244个key完全一致
- [x] 审查通知/引用等静态数据 - 全部双语
- [x] 修复发现的问题（extractUserProfile 4个system prompt、stats-service getStreakLevel）
- [x] 验证TypeScript编译和测试通过（tsc 0错误，126测试通过）


## 英文模式下智者聊天回复中文Bug修复（三次修复）
- [x] 排查chat.tsx中language参数传递链路 - 前端传递正确
- [x] 排查服务端generateChat的language参数接收和使用 - 逻辑正确但模型不够遵守
- [x] 修复问题：在用户消息前添加最终语言强制system message
- [x] 添加调试日志确认language参数值


## 从History界面进入智者对话英文模式回复中文Bug
- [x] 排查History界面进入智者对话的入口和language传递 - entry-detail→master-modal→chat
- [x] 排查entry-detail中的"与智者对话"按钮跳转逻辑 - 发现chatHistory含中文导致AI回复中文
- [x] 修复：1)「主题」改双语 2)chatHistory前加NOTE 3)用户消息前加CRITICAL REMINDER
- [x] 确认所有19个AI端点均有语言强制指令


## invokeLLM语言检测+自动重试机制
- [x] 阅读invokeLLM实现，设计语言检测包装函数
- [x] 实现invokeLLMWithLanguageGuard（30%中文字符阈值，自动重试1次）
- [x] 将所有19个AI端点的invokeLLM调用替换为invokeLLMWithLanguageGuard
- [x] TypeScript编译0错误，126测试通过


## 聊天回复报错TRPCClientError修复
- [x] 检查服务端日志 - 错误原因是 Unknown master: lao_tzu（旧缓存ID）
- [x] 修复：在两个generateChat中添加master ID映射（lao_tzu→laozi等）
- [x] TypeScript编译0错误

## 服务器日志排查修复
- [x] 修复AI返回旧master ID（lao_tzu/the_awakened_one/messenger_of_love/plato）导致chat页面Unknown master错误
- [x] 检查SafeAreaView废弃警告（React Navigation内部警告，不影响功能）
- [x] 检查Worklets key current警告（react-native-reanimated内部警告，不影响功能）

## 服务器断线问题排查
- [x] 排查服务器频繁断线的根本原因（sandbox休眠导致ngrok tunnel断开，与代码无关）
- [x] 分析断线是否与日志警告/报错有关（无关，确认是sandbox休眠机制导致）
- [x] 修复英文模式下AI返回连字符格式ID未被标准化的问题（扩展normalizeMasterId支持连字符和空格分隔符）

## UI 调整
- [x] 缩小智者总结页面（masters-summary）中的 emoji 图标尺寸（从48px缩小到28px，同时优化卡片内距和文字尺寸）

## 智者总结页面V4布局调整
- [x] 去掉摘要文字，只保留图标+名字
- [x] 副标题移到卡片下方并放大
- [x] Done按钮居中于副标题和底部之间
- [x] 去掉装饰表情

## 开发服务器连接问题
- [x] 排查 Expo Go 无法连接到开发服务器的原因 - 根因：之前使用沙箱代理URL而非ngrok tunnel URL
- [x] 恢复 tunnel 连接或重启服务器 - 使用正确的 ngrok tunnel URL: exp://cmpptoc-anonymous-8081.exp.direct

## 分享图片智者评论被截断
- [x] 定位分享图片生成代码，分析截断原因
- [ ] 方案1：保持原有字体大小，精简AI生成的内容长度（未选择）
- [x] 方案2：缩小字体，使智者的话能完整展示（动态字体：短文48px/中文40px/长文34px/超长28px）
- [x] 生成两个方案效果图供用户对比选择 - 用户选择方案B
- [x] 实现用户选择的方案 - 方案B已实现

## 分享卡片添加智者名称
- [x] 修改 WisdomShareCard 组件接口，添加 masterName 和 masterIcon 属性
- [x] 修改 saved-wisdom.tsx 调用方传入智者名称和图标
- [x] 卡片上展示智者名称（金色，居中，带图标）

## Expo Go 反复使用沙箱代理 URL 问题（根因修复）
- [x] 深度分析 Expo Go 获取 URL 的机制 - 根因：REACT_NATIVE_PACKAGER_HOSTNAME 和 EXPO_PACKAGER_PROXY_URL 被沙箱注入为 manus.computer 域名
- [x] 从根源修复 - 创建 start-metro.sh 包装脚本，启动前 unset 这两个变量

## 分享卡片上下间距过大
- [x] 减少分享卡片上下两端间距（padding 80→40, masterPadding 10→8, signaturePadding 20→8）
- [x] 生成效果预览图供用户确认

## 智者评论不是真实历史记录
- [x] 排查 entry-detail 页面智者评论的数据来源 - 根因：fallback占位文字被当作真实内容保存+显示
- [x] 修复 masters-summary.tsx：添加 isAIGenerated 标志，仅保存 AI 生成内容（不保存 fallback）
- [x] 修复 entry-detail.tsx：移除 120 行通用占位文字，无 mastersSummary 时显示友好提示
- [x] 优化 handleComplete：仅在自动保存失败时作为备份保存，避免重复写入
- [x] 编写 6 个单元测试全部通过，158 个已有测试无回归

## 重新生成智者评论按钮（entry-detail 页面）
- [x] 在智者评论区标题右侧添加 🔄 重新生成按钮
- [x] 无评论时显示「生成」按钮 + 提示文字，有评论时显示「重新生成」
- [x] 点击后调用 AI API 重新生成并保存到日记
- [x] 加载中显示 loading 状态（智者正在阅读你的文字...）
- [x] 编写 5 个单元测试全部通过

## Expo Go 无法连接开发服务器
- [x] 排查 Metro bundler 和后端服务器运行状态 - 两者均正常运行
- [x] 检查 URL 接口和网络配置 - 发现 oauth.ts 中硬编码的 API URL 使用了旧沙箱 ID
- [x] 修复 oauth.ts 第56行的硬编码 URL，更新为当前沙箱地址，重启服务器并验证

## API URL 动态注入（环境变量替代硬编码）
- [x] 修改 oauth.ts 移除硬编码 URL，改用 EXPO_PUBLIC_API_BASE_URL 环境变量
- [x] 通过 webdev_request_secrets 设置 EXPO_PUBLIC_API_BASE_URL
- [x] 验证 Metro(200) + API Health(200) + iOS Bundle(200, 11.8MB) 均正常，TS 编译 0 错误

## Expo Go 连接 ngrok tunnel 失败
- [ ] 排查 Metro 启动配置中的 tunnel/ngrok 模式
- [ ] 修复连接模式，确保 Expo Go 能稳定连接
