# 🚀 觉醒日志 - 后端部署指南

**项目名称**: 觉醒日志 (Awaken / Awakening Journal)  
**目标**: 将后端API部署到生产服务器

---

## 📋 你需要做什么

1. ✅ 在你的服务器上运行后端API
2. ✅ 配置PostgreSQL数据库
3. ✅ 配置环境变量（API密钥等）
4. ✅ 确保服务稳定运行
5. ✅ 提供API地址给前端开发者

## ❌ 你不需要做什么

- 不需要懂React Native
- 不需要懂Expo
- 不需要改前端代码
- 不需要发布App

---

## 🎯 技术栈

### 后端选择（二选一）

#### 选项1：Go后端（推荐）⭐

**优点**：
- 性能好，资源占用少
- 部署简单（单个二进制文件）
- 并发处理能力强

**技术栈**：
- Go 1.21+
- Gin框架（Web框架）
- GORM（ORM）
- PostgreSQL

#### 选项2：Node.js后端

**优点**：
- 你可能更熟悉
- 调试方便
- 生态丰富

**技术栈**：
- Node.js 22+
- Express + tRPC
- Drizzle ORM
- PostgreSQL

**两者功能完全一样，选你熟悉的即可。**

---

## 🚀 方案A：Go后端部署（推荐）

### 前置要求

- Linux服务器（Ubuntu 20.04+推荐）
- Docker & Docker Compose
- 域名（可选，但推荐）

### 步骤1：上传代码

```bash
# 上传整个项目文件夹到服务器
# 或使用 scp/sftp

cd /path/to/gratitude_journal_app/server-go
```

### 步骤2：配置环境变量

```bash
# 创建 .env 文件
cat > .env << 'EOF'
# 服务器配置
PORT=3000
HOST=0.0.0.0

# 数据库
DATABASE_URL=postgresql://awaken:your_password@db:5432/awaken_prod

# JWT密钥（随机生成一个）
JWT_SECRET=请生成一个随机字符串

# OpenRouter AI（需要申请）
OPENROUTER_API_KEY=sk-or-v1-xxxxx
OPENROUTER_MODEL=google/gemini-2.0-flash-exp:free

# 邮件服务（Gmail）
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=cloudycaddy@gmail.com
EMAIL_PASSWORD=Gmail应用专用密码

# CORS（允许所有来源，生产环境建议限制）
ALLOWED_ORIGINS=*
EOF
```

**重要**：
- `JWT_SECRET`: 运行 `openssl rand -base64 32` 生成
- `OPENROUTER_API_KEY`: 从 https://openrouter.ai/ 获取
- `EMAIL_PASSWORD`: 从Google账户安全设置获取应用专用密码

### 步骤3：启动服务

```bash
# 使用Docker Compose（最简单）
docker-compose up -d

# 查看日志
docker-compose logs -f

# 查看状态
docker-compose ps
```

### 步骤4：验证部署

```bash
# 测试健康检查
curl http://localhost:3000/health

# 应该返回
{"status":"ok","timestamp":"2026-01-05T..."}
```

### 步骤5：配置Nginx反向代理（推荐）

```nginx
# /etc/nginx/sites-available/awaken-api

server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/awaken-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 步骤6：配置SSL证书（推荐）

```bash
# 使用 Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com
```

### ✅ 完成！

API地址：`https://api.yourdomain.com`

---

## 🚀 方案B：Node.js后端部署

### 前置要求

- Linux服务器
- Node.js 22+
- pnpm
- PostgreSQL

### 步骤1：上传代码

```bash
cd /path/to/gratitude_journal_app/server
```

### 步骤2：安装依赖

```bash
pnpm install
```

### 步骤3：配置环境变量

```bash
# 创建 .env 文件（同Go版本）
cat > .env << 'EOF'
PORT=3000
DATABASE_URL=postgresql://user:password@localhost:5432/awaken_prod
JWT_SECRET=your-secret-key
OPENROUTER_API_KEY=sk-or-v1-xxxxx
OPENROUTER_MODEL=google/gemini-2.0-flash-exp:free
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=cloudycaddy@gmail.com
EMAIL_PASSWORD=your-gmail-app-password
EOF
```

### 步骤4：初始化数据库

```bash
pnpm db:push
```

### 步骤5：构建

```bash
pnpm build
```

### 步骤6：使用PM2运行

```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start dist/index.js --name awaken-api

# 查看状态
pm2 status

# 查看日志
pm2 logs awaken-api

# 开机自启
pm2 startup
pm2 save
```

### 步骤7：配置Nginx和SSL

（同Go版本）

---

## 🔑 环境变量说明

### PORT
- **说明**：API服务器监听端口
- **默认**：3000
- **建议**：保持3000，用Nginx反向代理

### DATABASE_URL
- **说明**：PostgreSQL连接字符串
- **格式**：`postgresql://用户名:密码@主机:端口/数据库名`
- **示例**：`postgresql://awaken:pass123@localhost:5432/awaken_prod`

### JWT_SECRET
- **说明**：JWT token加密密钥
- **要求**：随机字符串，至少32位
- **生成**：`openssl rand -base64 32`

### OPENROUTER_API_KEY
- **说明**：OpenRouter AI服务密钥
- **获取**：https://openrouter.ai/ → 注册 → Keys
- **格式**：`sk-or-v1-xxxxx`
- **免费模型**：`google/gemini-2.0-flash-exp:free`（无限制）

### EMAIL_USER & EMAIL_PASSWORD
- **说明**：Gmail SMTP发送验证码
- **获取密码**：
  1. 访问 https://myaccount.google.com/security
  2. 启用两步验证
  3. 创建应用专用密码（选择"邮件"）
  4. 复制16位密码
- **格式**：`abcd efgh ijkl mnop`

---

## 📊 服务器配置建议

### 初期（<1000用户）

- **CPU**：1核
- **内存**：1GB
- **硬盘**：20GB SSD
- **带宽**：1Mbps
- **月费用**：¥50-100

**推荐服务商**：
- 阿里云轻量应用服务器
- 腾讯云轻量应用服务器
- Vultr
- DigitalOcean

### 中期（1000-10000用户）

- **CPU**：2核
- **内存**：4GB
- **硬盘**：40GB SSD
- **带宽**：3Mbps
- **月费用**：¥200-500

### 大规模（>10000用户）

- **CPU**：4核+
- **内存**：8GB+
- **硬盘**：100GB+ SSD
- **带宽**：10Mbps+
- **月费用**：¥1000+

---

## 🔐 安全检查清单

### 必须做

- [ ] 使用HTTPS（配置SSL证书）
- [ ] 设置防火墙（只开放80, 443, 22端口）
- [ ] 修改SSH默认端口
- [ ] 禁用root直接登录
- [ ] 设置强密码
- [ ] 定期更新系统

### 推荐做

- [ ] 配置自动备份数据库
- [ ] 设置监控告警
- [ ] 配置日志轮转
- [ ] 限制API请求频率
- [ ] 配置CORS白名单（生产环境）

---

## 📈 监控和维护

### 日志查看

**Docker方式**：
```bash
docker-compose logs -f
```

**PM2方式**：
```bash
pm2 logs awaken-api
```

### 性能监控

```bash
# CPU和内存
htop

# 磁盘使用
df -h

# 网络连接
netstat -an | grep 3000
```

### 数据库备份

```bash
# 手动备份
pg_dump -U awaken awaken_prod > backup_$(date +%Y%m%d).sql

# 自动备份（添加到crontab）
0 2 * * * pg_dump -U awaken awaken_prod > /backups/awaken_$(date +\%Y\%m\%d).sql
```

---

## 🐛 常见问题

### Q: 数据库连接失败

**检查**：
```bash
# PostgreSQL是否运行
sudo systemctl status postgresql

# 连接字符串是否正确
echo $DATABASE_URL
```

### Q: API返回500错误

**检查日志**：
```bash
# Docker
docker-compose logs api

# PM2
pm2 logs awaken-api
```

### Q: 邮件发送失败

**检查**：
- Gmail应用密码是否正确
- 是否启用了两步验证
- 端口587是否开放

### Q: OpenRouter API不工作

**检查**：
- API密钥是否正确
- 是否有额度（免费模型无限制）
- 网络是否能访问openrouter.ai

---

## 🔄 更新部署

### Docker方式

```bash
# 1. 停止服务
docker-compose down

# 2. 拉取新代码
git pull  # 或重新上传

# 3. 重新构建并启动
docker-compose up -d --build

# 4. 查看日志确认
docker-compose logs -f
```

### PM2方式

```bash
# 1. 拉取新代码
git pull  # 或重新上传

# 2. 重新构建
pnpm build

# 3. 重启服务
pm2 restart awaken-api

# 4. 查看日志
pm2 logs awaken-api
```

---

## 📞 完成后提供给前端开发者

### 需要提供的信息

1. **API地址**
   - 示例：`https://api.yourdomain.com`
   - 或：`http://你的服务器IP:3000`

2. **健康检查URL**
   - `https://api.yourdomain.com/health`

3. **确认服务正常运行**
   - 健康检查返回200
   - 日志无错误

### 前端开发者需要做什么

```bash
# 前端只需要更新 .env 文件
EXPO_PUBLIC_API_URL=https://api.yourdomain.com
```

然后重新构建App，就完成了！

---

## 📚 参考文档

### 项目文档

- `server-go/README.md` - Go后端详细文档
- `server/README.md` - Node.js后端详细文档
- `API_DOCUMENTATION.md` - API接口文档
- `DEPLOYMENT_GUIDE_FULL.md` - 完整部署指南
- `GO_BACKEND_ARCHITECTURE.md` - Go后端架构说明

### 外部资源

- [Docker文档](https://docs.docker.com/)
- [PostgreSQL文档](https://www.postgresql.org/docs/)
- [Nginx文档](https://nginx.org/en/docs/)
- [Let's Encrypt](https://letsencrypt.org/)

---

## ✅ 部署检查清单

完成后确认：

- [ ] 服务器正常运行
- [ ] 数据库连接正常
- [ ] API健康检查返回OK
- [ ] 可以创建用户账号
- [ ] 可以发送验证码邮件
- [ ] AI功能正常工作（4位智者）
- [ ] 配置了HTTPS
- [ ] 配置了防火墙
- [ ] 配置了自动备份
- [ ] 提供了API地址给前端开发者

---

## 🎯 快速开始（5分钟）

### 使用Docker（最简单）

```bash
# 1. 进入Go后端目录
cd server-go

# 2. 创建.env文件（填写必要配置）
nano .env

# 3. 启动
docker-compose up -d

# 4. 检查
curl http://localhost:3000/health

# 完成！
```

---

**祝部署顺利！** 🚀

有问题请查看项目中的详细文档或检查日志。
